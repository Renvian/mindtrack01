<!DOCTYPE html>
<html>
<head>
    <title>Patient Profile</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="supabase-config.js"></script>
    <script src="auth.js"></script>
    <script src="gemini.js"></script>
    <script src="charts-logic.js"></script>
    <script src="records.js"></script>
</head>
<body>
    <div class="container">
        <a href="doctor-dashboard.html" class="btn btn-secondary">‚Üê Back</a>
        <h2 id="pName">Loading...</h2>
        
        <div class="grid">
            <div class="card">
                <h3>Trend Analysis</h3>
                <canvas id="lineChart"></canvas>
            </div>
            <div class="card">
                <h3>Mood Distribution</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="card" style="background: #fdf2f8; border: 1px solid #fbcfe8;">
            <h3>‚ú® AI Trend Summary</h3>
            <p id="aiSummary">Generating insights...</p>
        </div>

        <hr style="border: 1px solid var(--bg-color); margin: 40px 0;">

        <div class="grid">
            <div class="card" style="border-top: 5px solid var(--secondary);">
                <h3>üíú Clinical Notes</h3>
                <p style="font-size: 0.8rem; color: #666;">Observations and session history</p>
                <textarea id="clinicalNotes" style="height: 250px; border: 1px solid #E0D5E8;" placeholder="Start typing session notes..."></textarea>
                <button class="btn" style="width: 100%; margin-top: 10px;" onclick="saveRecord('notes')">Save Notes</button>
            </div>

            <div class="card" style="border-top: 5px solid #F5A8C1;">
                <h3>üå∏ Treatment Plan</h3>
                <p style="font-size: 0.8rem; color: #666;">Medications, therapy, and goals</p>
                <textarea id="treatmentPlan" style="height: 250px; border: 1px solid #FDE7EF;" placeholder="Outline the treatment plan..."></textarea>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 10px; background: #F5A8C1;" onclick="saveRecord('plan')">Save Treatment Plan</button>
            </div>
        </div>
    </div>

    <script>
        async function init() {
            await checkSession();
            const pid = localStorage.getItem('current_patient');
            
            // Fetch Patient Info
            const { data: p } = await window.sb.from('patients').select('name').eq('id', pid).single();
            document.getElementById('pName').innerText = p.name;

            // Fetch Data
            const { data: tests } = await window.sb.from('assessments').select('*').eq('patient_id', pid).order('created_at');
            const { data: moods } = await window.sb.from('mood_logs').select('*').eq('patient_id', pid).order('created_at');

            // Process Data for Charts
            const phq = tests.filter(t => t.test_type === 'PHQ-9').map(t => t.score);
            const gad = tests.filter(t => t.test_type === 'GAD-7').map(t => t.score);
            const pss = tests.filter(t => t.test_type === 'PSS-10').map(t => t.score);
            const moodScores = moods.map(m => m.mood_score);

            // Render
            renderCharts(phq, gad, pss, moodScores);

            // AI
            const summary = await generateInsight(p.name, phq, gad, pss, moodScores);
            document.getElementById('aiSummary').innerText = summary;

            // Load Patient Records (Notes & Treatment Plan)
            await loadPatientRecords();
        }
        init();
    </script>
</body>
</html>